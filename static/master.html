<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Extensão - Professor</title>
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
    <script>
        let ws = null;
        let timer = null;
        let game_time = 0;
        function handle_message(message) {
            switch (message.cmd) {
                case "started": {
                    show_page("questions");
                    let remaining_time = document.getElementById("remaining_time");
                    timer = startCountDown(message.args.remaining, function(text) {
                        remaining_time.innerText = text;
                    });
                    let scoreboard_tbody = document.getElementById("scoreboard_tbody");
                    scoreboard_tbody.innerHTML = "";
                    return;
                }
                case "finished": {
                    if (timer) {
                        timer.stop();
                        timer = null;
                    }
                    console.log(message.args.answers);
                    let scoreboard_tbody = document.getElementById("scoreboard_tbody");
                    scoreboard_tbody.innerHTML = "";
                    show_page("scoreboard");
                    for (let i = 0; i < message.args.answers.length; i++) {
                        message.args.key = message.args.sckid + ":" + message.args.question;
                        update_tbody(scoreboard_tbody, message.args.answers[i], "key", ["sckid", "name", "group", "question", "answer"]);
                    }
                    return;
                }
                case "extra_time": {
                    if (timer) {
                        timer.extra(message.args.seconds);
                    }
                    return;
                }
                case "room_closed": {
                    post("/sala/sair");
                    show_page("home_page");
                    ws.close();
                    return;
                }
                case "question_answered": {
                    let questions_tbody = document.getElementById("questions_tbody");
                    message.args.key = message.args.sckid + ":" + message.args.question;
                    update_tbody(questions_tbody, message.args, "key", ["sckid", "name", "group", "question", "answer"]);
                    return;
                }
                case "game_time_changed": {
                    game_time = message.args.game_time;
                    document.getElementById("room_game_time").innerText = "O evento vai durar " + message.args.game_time + " segundos";
                    return;
                }
                case "group_count_changed": {
                    if (message.args.group_count === 0) {
                        document.getElementById("room_group_count").innerText = "O evento será individual";
                    } else {
                        document.getElementById("room_group_count").innerText = "O evento terá " + message.args.group_count + " grupos";
                    }
                    return;
                }
                case "member_updated": {
                    let members_tbody = document.getElementById("members_tbody");
                    update_tbody(members_tbody, message.args, "sckid", ["sckid", "name", "group"]);
                    return;
                }
                case "member_left": {
                    let members_tbody = document.getElementById("members_tbody");
                    update_tbody_delete(members_tbody, message.args.sckid);
                    return;
                }
            }
        }
        function main() {
            let session = get_session();

            document.getElementById("master_roomid").innerText = "O código da sala é " + session.roomid;

            ws = connection(handle_message);

            document.getElementById("room_mode_select").addEventListener("change", function () {
                ws.send({ cmd: "set_group_count", args: { "group_count": Number(this.value) } });
            });
            document.getElementById("room_time_seconds").addEventListener("change", function () {
                ws.send({ cmd: "set_time", args: { "seconds": Number(this.value) } });
            });
            document.getElementById("btn_start_game").addEventListener("click", function () {
                ws.send({ cmd: "start", args: {} });
            });
            document.getElementById("btn_close_room").addEventListener("click", function () {
                ws.send({ cmd: "close_room", args: {} });
            });
            document.getElementById("finish_game_early").addEventListener("click", function () {
                ws.send({ cmd: "finish", args: {} });
            });
            document.getElementById("add_extra_time").addEventListener("click", function () {
                ws.send({ cmd: "extra_time", args: { seconds: 10 } });
            });
            document.getElementById("exit_scoreboard").addEventListener("click", function () {
                show_page("main");
            });
        }
        document.addEventListener("DOMContentLoaded", main);
    </script>
</head>
<body>
    <h1>Projeto de Extensão Debug, Página do Professor</h1>
    <form action="/sala/sair" method="post">
        <button id="clear_cookie" type="submit">Apagar Cookie de Sessão</button>
    </form>
    <br><br>
    <div id="main" class="page">
        <h3 id="master_roomid"></h3>
        <h3>O sckid do professor é 0</h3>
        <h4>Selecione o número de grupos:</h4>
        <select id="room_mode_select">
            <option value="0">Individual</option>
            <option value="2">2 grupos</option>
            <option value="3">3 grupos</option>
            <option value="4">4 grupos</option>
        </select>
        <br><br>
        <h4>Selecione o tempo do jogo (segundos):</h4>
        <input type="number" id="room_time_seconds" value="60">
        <br><br>
        <button id="btn_start_game">Começar Jogo</button>
        <br><br>
        <button id="btn_close_room">Fechar Sala</button>
        <br><br>
        <h4>Lista de alunos conectados:</h4>
        <h4 id="room_group_count"></h4>
        <h4 id="room_game_time"></h4>
        <table>
            <thead>
                <tr>
                    <th>sckid</th>
                    <th>nome</th>
                    <th>grupo</th>
                </tr>
            </thead>
            <tbody id="members_tbody"></tbody>
        </table>
    </div>
    <div id="questions" class="page hide">
        <h4>Questões respondidas</h4>
        <h5 id="remaining_time"></h5>
        <br><br>
        <table>
            <thead>
                <tr>
                    <th>sckid</th>
                    <th>nome</th>
                    <th>grupo</th>
                    <th>question</th>
                    <th>answer</th>
                </tr>
            </thead>
            <tbody id="questions_tbody"></tbody>
        </table>
        <button id="finish_game_early">Terminar o jogo</button>
        <button id="add_extra_time">Acrescentar 10 segundos</button>
    </div>
    <div id="scoreboard" class="page hide">
        <h4>Resultado Final</h4>
        <table>
            <thead>
                <tr>
                    <th>sckid</th>
                    <th>nome</th>
                    <th>grupo</th>
                    <th>question</th>
                    <th>answer</th>
                </tr>
            </thead>
            <tbody id="scoreboard_tbody"></tbody>
        </table>
        <br><br>
        <button id="exit_scoreboard">Voltar</button>
    </div>
</body>
</html>