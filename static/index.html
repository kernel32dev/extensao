<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Extensão</title>
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
    <script>
        let ws = null;
        let timer = null;
        let game_time = 0;
        function handle_message(message) {
            switch (message.cmd) {
                case "started": {
                    if (ws.sckid === 0) {
                        show_page("master_questions");
                    } else {
                        show_page("member_questions");
                    }
                    let member_time = document.getElementById("member_time");
                    let master_time = document.getElementById("master_time");
                    timer = startCountDown(message.args.remaining, function(text) {
                        member_time.innerText = text;
                        master_time.innerText = text;
                    });
                    let scoreboard_tbody = document.getElementById("scoreboard_tbody");
                    scoreboard_tbody.innerHTML = "";
                    return;
                }
                case "finished": {
                    if (timer) {
                        timer.stop();
                        timer = null;
                    }
                    console.log(message.args.answers);
                    let scoreboard_tbody = document.getElementById("scoreboard_tbody");
                    scoreboard_tbody.innerHTML = "";
                    show_page("scoreboard");
                    for (let i = 0; i < message.args.answers.length; i++) {
                        message.args.key = message.args.sckid + ":" + message.args.question;
                        update_tbody(scoreboard_tbody, message.args.answers[i], "key", ["sckid", "name", "group", "question", "answer"]);
                    }
                    return;
                }
                case "extra_time": {
                    if (timer) {
                        timer.extra(message.args.seconds);
                    }
                    return;
                }
                case "room_closed": {
                    post("/sala/sair");
                    show_page("home_page");
                    ws.close();
                    return;
                }
                case "question_answered": {
                    let questions_tbody = document.getElementById("questions_tbody");
                    message.args.key = message.args.sckid + ":" + message.args.question;
                    update_tbody(questions_tbody, message.args, "key", ["sckid", "name", "group", "question", "answer"]);
                    return;
                }
                case "game_time_changed": {
                    game_time = message.args.game_time;
                    document.getElementById("room_game_time").innerText = "O evento vai durar " + message.args.game_time + " segundos";
                    return;
                }
                case "group_count_changed": {
                    if (message.args.group_count === 0) {
                        document.getElementById("room_group_count").innerText = "O evento será individual";
                    } else {
                        document.getElementById("room_group_count").innerText = "O evento terá " + message.args.group_count + " grupos";
                    }
                    return;
                }
                case "questions_changed": {
                    document.getElementById("room_questions").innerText = "O conjunto de questões será \"" + message.args.questions + "\"";
                    return;
                }
                case "member_updated": {
                    let members_tbody = document.getElementById("members_tbody");
                    update_tbody(members_tbody, message.args, "sckid", ["sckid", "name", "group"]);
                    return;
                }
                case "member_left": {
                    let members_tbody = document.getElementById("members_tbody");
                    update_tbody_delete(members_tbody, message.args.sckid);
                    return;
                }
            }
        }
        document.addEventListener("DOMContentLoaded", function () {
            let session = get_session();
            if (session) {
                if (session.sckid === 0) {
                    show_page("master_page", "member_list");
                    document.getElementById("master_roomid").innerText = "O código da sala é " + session.roomid;
                } else {
                    show_page("member_page", "member_list");
                    document.getElementById("member_roomid").innerText = "O código da sala é " + session.roomid;
                    document.getElementById("member_sckid").innerText = "O sckid deste aluno é " + session.sckid;
                }
                ws = connection(handle_message);
                ws.roomid = session.roomid;
                ws.sckid = session.sckid;
            }
            document.getElementById("clear_cookie").addEventListener("click", function () {
                post("/sala/sair");
                show_page("home_page");
                ws.close();
                ws = null;
                return;
            });
            document.getElementById("create_room").addEventListener("click", function () {
                let roomid = document.getElementById('roomid').value;
                post("/sala", function (roomid) {
                    show_page("master_page", "member_list");
                    document.getElementById("member_roomid").innerText = "O código da sala é " + roomid;
                    ws = connection(handle_message);
                    ws.roomid = roomid;
                    ws.sckid = 0;
                });
            });
            document.getElementById("join_room").addEventListener("click", function () {
                let roomid = document.getElementById('roomid').value;
                post("/sala/" + roomid, function (sckid) {
                    show_page("member_page", "member_list");
                    document.getElementById("member_roomid").innerText = "O código da sala é " + roomid;
                    document.getElementById("member_sckid").innerText = "O sckid deste aluno é " + sckid;
                    ws = connection(handle_message);
                    ws.roomid = roomid;
                    ws.sckid = Number(sckid);
                });
            });
            document.getElementById("room_mode_select").addEventListener("input", function () {
                if (ws) ws.send({ cmd: "set_group_count", args: { "group_count": Number(this.value) } });
            });
            document.getElementById("input_room_time_seconds").addEventListener("input", function () {
                if (ws) ws.send({ cmd: "set_time", args: { "seconds": Number(this.value) } });
            });
            document.getElementById("input_room_questions").addEventListener("input", function () {
                if (ws) ws.send({ cmd: "set_questions", args: { "questions": this.value } });
            });
            document.getElementById("btn_start_game").addEventListener("click", function () {
                if (ws) ws.send({ cmd: "start", args: {} });
            });
            document.getElementById("btn_close_room").addEventListener("click", function () {
                if (ws) ws.send({ cmd: "close_room", args: {} });
            });
            document.getElementById("member_name").addEventListener("input", function () {
                if (ws) ws.send({ cmd: "set_name", args: { "name": this.value } });
            });
            document.getElementById("submit_answer").addEventListener("click", function () {
                let question = document.getElementById("input_question");
                let answer = document.getElementById("input_answer");
                if (ws) ws.send({ cmd: "answer", args: { "question": Number(question.value), "answer": Number(answer.value) } });
                question.value = undefined;
                answer.value = undefined;
            });
            document.getElementById("finish_game_early").addEventListener("click", function () {
                if (ws) ws.send({ cmd: "finish", args: {} });
            });
            document.getElementById("add_extra_time").addEventListener("click", function () {
                if (ws) ws.send({ cmd: "extra_time", args: { seconds: 10 } });
            });
            document.getElementById("exit_scoreboard").addEventListener("click", function () {
                if (ws) {
                    if (ws.sckid === 0) {
                        show_page("master_page", "member_list");
                    } else {
                        show_page("member_page", "member_list");
                    }
                }
            });
        });
    </script>
</head>
<body>
    <h1>Projeto de Extensão Debug</h1>
    <button id="clear_cookie">Apagar Cookie de Sessão</button>
    <br><br>
    <div id="home_page" class="page">
        <h1>Criar / Conectar</h1>
        <h3>Criar Sala</h3>
        <button id="create_room">Criar Sala</button>
        <br>
        <h3>Conectar a sala</h3>
        <input type="text" id="roomid">
        <button id="join_room">Conectar a sala</button>
    </div>
    <div id="master_page" class="page hide">
        <h1>Página do professor</h1>
        <h3 id="master_roomid"></h3>
        <h3>O sckid do professor é 0</h3>
        <h4>Selecione o número de grupos:</h4>
        <select id="room_mode_select">
            <option value="0">Individual</option>
            <option value="2">2 grupos</option>
            <option value="3">3 grupos</option>
            <option value="4">4 grupos</option>
        </select>
        <br><br>
        <h4>Selecione o tempo do jogo (segundos):</h4>
        <input type="number" id="input_room_time_seconds" value="300">
        <br><br>
        <h4>Selecione o conjunto de questões:</h4>
        <input type="text" id="input_room_questions" value="default">
        <br><br>
        <button id="btn_start_game">Começar Jogo</button>
        <br><br>
        <button id="btn_close_room">Fechar Sala</button>
    </div>
    <div id="member_page" class="page hide">
        <h1>Página do aluno</h1>
        <h3 id="member_roomid"></h3>
        <h3 id="member_sckid"></h3>
        <h4>Nome do aluno:</h4>
        <input type="text" id="member_name">
    </div>
    <div id="member_list" class="page hide">
        <h4>Lista de alunos conectados:</h4>
        <h4 id="room_group_count"></h4>
        <h4 id="room_game_time"></h4>
        <h4 id="room_questions"></h4>
        <table>
            <thead>
                <tr>
                    <th>sckid</th>
                    <th>nome</th>
                    <th>grupo</th>
                </tr>
            </thead>
            <tbody id="members_tbody"></tbody>
        </table>
    </div>
    <div id="member_questions" class="page hide">
        <h4>Responder questão</h4>
        <h5 id="member_time"></h5>
        <br><br>
        <input type="number" id="input_question">
        <br><br>
        <input type="number" id="input_answer">
        <br><br>
        <button id="submit_answer">Responder</button>
    </div>
    <div id="master_questions" class="page hide">
        <h4>Questões respondidas</h4>
        <h5 id="master_time"></h5>
        <br><br>
        <table>
            <thead>
                <tr>
                    <th>sckid</th>
                    <th>nome</th>
                    <th>grupo</th>
                    <th>question</th>
                    <th>answer</th>
                </tr>
            </thead>
            <tbody id="questions_tbody"></tbody>
        </table>
        <button id="finish_game_early">Terminar o jogo</button>
        <button id="add_extra_time">Acrescentar 10 segundos</button>
    </div>
    <div id="scoreboard" class="page hide">
        <h4>Resultado Final</h4>
        <br><br>
        <table>
            <thead>
                <tr>
                    <th>sckid</th>
                    <th>nome</th>
                    <th>grupo</th>
                    <th>question</th>
                    <th>answer</th>
                </tr>
            </thead>
            <tbody id="scoreboard_tbody"></tbody>
        </table>
        <br><br>
        <button id="exit_scoreboard">Voltar</button>
    </div>
</body>
</html>