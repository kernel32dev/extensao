<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Extensão - Aluno</title>
    <link rel="stylesheet" href="style.css">
    <script src="script.js"></script>
    <script>
        let ws = null;
        let timer = null;
        let game_time = 0;
        function handle_message(message) {
            switch (message.cmd) {
                case "started": {
                    show_page("questions");
                    let remaining_time = document.getElementById("remaining_time");
                    timer = startCountDown(message.args.remaining, function(text) {
                        remaining_time.innerText = text;
                    });
                    let scoreboard_tbody = document.getElementById("scoreboard_tbody");
                    scoreboard_tbody.innerHTML = "";
                    return;
                }
                case "finished": {
                    if (timer) {
                        timer.stop();
                        timer = null;
                    }
                    console.log(message.args.answers);
                    let scoreboard_tbody = document.getElementById("scoreboard_tbody");
                    scoreboard_tbody.innerHTML = "";
                    show_page("scoreboard");
                    for (let i = 0; i < message.args.answers.length; i++) {
                        message.args.key = message.args.sckid + ":" + message.args.question;
                        update_tbody(scoreboard_tbody, message.args.answers[i], "key", ["sckid", "name", "group", "question", "answer"]);
                    }
                    return;
                }
                case "extra_time": {
                    if (timer) {
                        timer.extra(message.args.seconds);
                    }
                    return;
                }
                case "room_closed": {
                    post("/sala/sair");
                    show_page("home_page");
                    ws.close();
                    return;
                }
                case "game_time_changed": {
                    game_time = message.args.game_time;
                    document.getElementById("room_game_time").innerText = "O evento vai durar " + message.args.game_time + " segundos";
                    return;
                }
                case "group_count_changed": {
                    if (message.args.group_count === 0) {
                        document.getElementById("room_group_count").innerText = "O evento será individual";
                    } else {
                        document.getElementById("room_group_count").innerText = "O evento terá " + message.args.group_count + " grupos";
                    }
                    return;
                }
                case "member_updated": {
                    let members_tbody = document.getElementById("members_tbody");
                    update_tbody(members_tbody, message.args, "sckid", ["sckid", "name", "group"]);
                    return;
                }
                case "member_left": {
                    let members_tbody = document.getElementById("members_tbody");
                    update_tbody_delete(members_tbody, message.args.sckid);
                    return;
                }
            }
        }
        function main() {
            let session = get_session();

            document.getElementById("member_roomid").innerText = "O código da sala é " + session.roomid;
            document.getElementById("member_sckid").innerText = "O sckid deste aluno é " + session.sckid;

            ws = connection(handle_message);

            document.getElementById("member_name").addEventListener("change", function () {
                if (ws) ws.send({ cmd: "set_name", args: { "name": this.value } });
            });
            document.getElementById("submit_answer").addEventListener("click", function () {
                let question = document.getElementById("input_question").value;
                let answer = document.getElementById("input_answer").value;
                if (ws) ws.send({ cmd: "answer", args: { "question": Number(question), "answer": Number(answer) } });
            });
            document.getElementById("exit_scoreboard").addEventListener("click", function () {
                show_page("main");
            });
        }
        document.addEventListener("DOMContentLoaded", main);
    </script>
</head>
<body>
    <h1>Projeto de Extensão Debug, Página do Aluno</h1>
    <form action="/sala/sair" method="post">
        <button id="clear_cookie" type="submit">Apagar Cookie de Sessão</button>
    </form>
    <br><br>
    <div id="main" class="page">
        <h1>Página do aluno</h1>
        <h3 id="member_roomid"></h3>
        <h3 id="member_sckid"></h3>
        <h4>Dados do aluno:</h4>
        <input type="text" id="member_name">
        <br><br>
        <h4>Lista de alunos conectados:</h4>
        <h4 id="room_group_count"></h4>
        <h4 id="room_game_time"></h4>
        <table>
            <thead>
                <tr>
                    <th>sckid</th>
                    <th>nome</th>
                    <th>grupo</th>
                </tr>
            </thead>
            <tbody id="members_tbody"></tbody>
        </table>
    </div>
    <div id="questions" class="page hide">
        <h4>Responder questão</h4>
        <h5 id="remaining_time"></h5>
        <br><br>
        <input type="number" id="input_question">
        <br><br>
        <input type="number" id="input_answer">
        <br><br>
        <button id="submit_answer">Responder</button>
    </div>
    <div id="scoreboard" class="page hide">
        <h4>Resultado Final</h4>
        <table>
            <thead>
                <tr>
                    <th>sckid</th>
                    <th>nome</th>
                    <th>grupo</th>
                    <th>question</th>
                    <th>answer</th>
                </tr>
            </thead>
            <tbody id="scoreboard_tbody"></tbody>
        </table>
        <br><br>
        <button id="exit_scoreboard">Voltar</button>
    </div>
</body>
</html>